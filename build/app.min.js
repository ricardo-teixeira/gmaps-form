(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define([], factory);
  } else if (typeof exports !== "undefined") {
    factory();
  } else {
    var mod = {
      exports: {}
    };
    factory();
    global.app = mod.exports;
  }
})(this, function () {
  'use strict';

  (function (win, doc) {
    "use strict";

    var $form = doc.getElementById('mapsForm');
    var $modal = $('#mapsModal');
    var map, marker, autocomplete, geocoder;
    var initialData = {
      // street: 'Mário Carniceli',
      // country: 'BR',
      // state: 'SP',
      // city: 'Campinas'
    };

    function Field(props) {
      var defaults = {
        value: '',
        required: true
      };
      return Object.assign({}, defaults, props);
    }

    var FORM_FIELDS_SCHEMA = {
      street: new Field(),
      country: new Field(),
      state: new Field(),
      city: new Field(),
      neighborhood: new Field({ required: false }),
      cep: new Field(),
      lat: new Field(),
      lng: new Field()
    };

    var FORM_FIELDS_MAP = {
      route: ['long_name', 'street'],
      country: ['short_name', 'country'],
      administrative_area_level_2: ['long_name', 'city'],
      administrative_area_level_1: ['short_name', 'state'],
      sublocality_level_1: ['long_name', 'neighborhood'],
      postal_code: ['long_name', 'cep']
    };
    /****************************/

    function fetchBasicFields() {
      $.when(getCountries(), getStates(), getCities()).then(function () {
        setTimeout(function () {
          updateForm(initialData);
        }, 1000);
      });
    }

    function getCountries() {
      $.ajax({
        method: 'GET',
        url: 'src/json/countries.json'
      }).then(function (response) {
        var $countriesSelect = $form.querySelector('[name="country"]');
        var $countryList = '<option value="">Selecione</option>';
        response.forEach(function (country) {
          return $countryList += '<option value="' + country.iso + '">' + country.name + '</option>';
        });

        $countriesSelect.innerHTML = $countryList;
      });
    }

    function getStates() {
      $.ajax({
        method: 'GET',
        url: 'src/json/states.json'
      }).then(function (response) {
        var $statesSelect = $form.querySelector('[name="state"]');
        var $stateList = '<option value="">Selecione</option>';
        response.forEach(function (state) {
          return $stateList += '<option value="' + state.code + '">' + state.name + '</option>';
        });

        $statesSelect.innerHTML = $stateList;
      });
    }

    function getCities() {
      $.ajax({
        method: 'GET',
        url: 'src/json/cities.json'
      }).then(function (response) {
        var $citiesSelect = $form.querySelector('[name="city"]');
        var $cityList = '<option value="">Selecione</option>';
        response.forEach(function (city) {
          return $cityList += '<option value="' + city.name + '">' + city.name + '</option>';
        });

        $citiesSelect.innerHTML = $cityList;
      });
    }
    /****************************/

    function updateForm(fields) {
      if (fields) {
        var address = Object.assign({}, FORM_FIELDS_SCHEMA, fields);

        Object.keys(address).forEach(function (field) {
          var element = $form.elements[field];
          if (element) {
            $form.elements[field].value = fields[field] && fields[field] != 'Unnamed Road' ? fields[field] : '';
          }
        });
      }
    }

    function geocodePosition(pos) {
      geocoder.geocode({
        latLng: pos
      }, function (responses) {
        if (responses && responses.length > 0) {
          var address = mapApiToFormFields(responses[0]);
          address.lat = pos.lat;
          address.lng = pos.lng;
          updateForm(address);
          resetMapPosition(pos, true);
        }
      });
    }

    function handleMarkerDrag(e) {
      var latLng = {
        lat: e.latLng.lat(),
        lng: e.latLng.lng()
      };
      geocodePosition(latLng);
    }

    function cleanFormErrors() {
      var $errorsText = $form.querySelectorAll('.text-danger');
      var $errorsClass = $form.querySelectorAll('.is-invalid');

      $errorsText.forEach(function (error) {
        error.remove();
      });

      $errorsClass.forEach(function (error) {
        error.classList.remove('is-invalid');
      });
    }

    function resetMapPosition(pos, zoom) {
      if (pos.lat && pos.lng) {
        map.setCenter(pos);
        marker.setPosition(pos);
        if (zoom) {
          map.setZoom(19);
        }
      }
    }

    function getFormValues() {
      var values = {};
      Object.keys(FORM_FIELDS_SCHEMA).forEach(function (key) {
        var field = $form.elements[key];
        if (field) {
          values[key] = $form.elements[key].value;
        }
      });

      return values;
    }

    function validateForm() {
      cleanFormErrors();

      var formValues = getFormValues();
      var isValid = Object.keys(formValues).every(function (key) {
        return !!formValues[key] || !FORM_FIELDS_SCHEMA[key].required;
      });

      return $.Deferred(function () {
        var self = this;

        if (!isValid) {
          Object.keys(formValues).forEach(function (key) {
            var $field = $form.elements[key];

            if (!$field.value && $field.type != 'hidden' && FORM_FIELDS_SCHEMA[key].required) {
              $field.classList.add('is-invalid');
              $field.parentNode.insertAdjacentHTML('afterend', '<small class="text-danger mt-2">Obrigatório</small>');
            }

            return !!formValues[key];
          });

          return self.resolve(false);
        }

        return validateAddressAsync(formValues).then(function () {
          return self.resolve(isValid);
        }).fail(function () {
          return self.reject(false);
        });
      });
    }

    function validateAddressAsync(address) {
      return $.Deferred(function () {
        var self = this;
        var latLng = {
          lat: parseFloat(address.lat),
          lng: parseFloat(address.lng)
        };

        geocoder.geocode({ 'location': latLng }, function (results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            var mapsAddress = mapApiToFormFields(results[0]);

            if (mapsAddress.street && mapsAddress.street != address.street) {
              $form.insertAdjacentHTML('afterend', '<small class="text-danger mt-2">Logradouro incorreto</small>');
            }

            if (mapsAddress.neighborhood && mapsAddress.neighborhood != address.neighborhood) {
              $form.insertAdjacentHTML('afterend', '<div class="is-invalid"><small class="text-danger mt-2">Bairro incorreto</small></div>');
            }

            if (mapsAddress.cep && mapsAddress.cep != address.cep) {
              $form.insertAdjacentHTML('afterend', '<div class="is-invalid"><small class="text-danger mt-2">Bairro incorreto</small></div>');
            }

            self.resolve();
          } else {
            self.reject();
          }
        });
      });
    }

    function handleSubmit(e, callback) {
      e.preventDefault();
      validateForm().then(function (valid) {
        if (valid) {
          var values = getFormValues();
          console.log('formFields', values);

          if (callback) {
            callback(values);
          }

          $modal.modal('hide');
          return;
        }
      });
    }

    function handleAutocomplete() {
      cleanFormErrors();
      var place = autocomplete.getPlace();
      if (Object.keys(place).length > 1) {
        var address = mapApiToFormFields(place);
        updateForm(address);
        resetMapPosition({ lat: address.lat, lng: address.lng }, true);
      }
    }

    function findLocation(value) {
      cleanFormErrors();
      geocoder.geocode({ 'address': value }, function (results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          var address = mapApiToFormFields(results[0]);
          var location = results[0].geometry.location;
          resetMapPosition({ lat: location.lat(), lng: location.lng() });
          updateForm(address);
        } else {
          console.error('Nenhum resultado encontrado');
          $form.insertAdjacentHTML('beforeend', '<div class="is-invalid"><small class="text-danger mt-2">Endereço não encontrado</small></div>');
        }
      });
    }

    function mapApiToFormFields(place) {
      var address = {};
      address.lat = place.geometry.location.lat();
      address.lng = place.geometry.location.lng();

      place.address_components.forEach(function (component) {
        var formField;

        component.types.forEach(function (type) {
          if (FORM_FIELDS_MAP[type]) {
            formField = FORM_FIELDS_MAP[type];
          }
        });

        if (formField) {
          var value = component[formField[0]];
          address[formField[1]] = value;
        }
      });

      return address;
    }

    function setLoading(show) {
      var $loading = document.getElementById('mapsLoading');
      if ($loading) {
        if (!show) {
          $loading.style.display = 'none';
        } else {
          $loading.style.display = 'block';
        }
      }
    }

    function initMap(formData, callback) {
      if (formData) {
        initialData = formData;
      }

      fetchBasicFields();
      // var latLng = {
      //   lat: initialData.lat,
      //   lng: initialData.lng
      // };

      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(doc.getElementById('map'), {
        // center: latLng,
        zoom: 12,
        mapTypeControl: true,
        mapTypeControlOptions: {
          position: google.maps.ControlPosition.TOP_CENTER
        },
        fullscreenControl: false
      });

      marker = new google.maps.Marker({
        // position: latLng,
        map: map,
        draggable: true
      });

      google.maps.event.addListener(marker, 'dragend', handleMarkerDrag);
      google.maps.event.addListener(map, 'tilesloaded', setLoading);

      autocomplete = new google.maps.places.Autocomplete(document.getElementById('autocomplete'), { types: ['geocode'] });
      autocomplete.addListener('place_changed', handleAutocomplete);

      $form.addEventListener('submit', function (e) {
        handleSubmit(e, callback);
      });

      $form.addEventListener('change', function (e) {
        switch (e.target.name) {
          case 'cep':
            findLocation(e.target.value);
          default:
            return false;
        }
      });

      $modal.on("shown.bs.modal", function () {
        google.maps.event.trigger(map, "resize");
        var address = [];

        Object.keys(initialData).forEach(function (key) {
          address.push(initialData[key]);
        });

        geocoder.geocode({ 'address': address.join(', ') }, function (results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            var location = results[0].geometry.location;
            resetMapPosition({ lat: location.lat(), lng: location.lng() });
          }
        });
      });
    }

    win.mapsAddressFinder = initMap;

    // doc.addEventListener('DOMContentLoaded', initMap)
  })(window, document);
});

//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LGFBQU8sRUFBUCxDQUFVLGdCQUFWLEVBQTRCLFlBQVk7QUFDdEMsZUFBTyxJQUFQLENBQVksS0FBWixDQUFrQixPQUFsQixDQUEwQixHQUExQixFQUErQixRQUEvQjtBQUNBLFlBQUksVUFBVSxFQUFkOztBQUVBLGVBQU8sSUFBUCxDQUFZLFdBQVosRUFBeUIsT0FBekIsQ0FBaUMsVUFBVSxHQUFWLEVBQWU7QUFDOUMsa0JBQVEsSUFBUixDQUFhLFlBQVksR0FBWixDQUFiO0FBQ0QsU0FGRDs7QUFJQSxpQkFBUyxPQUFULENBQWlCLEVBQUUsV0FBVyxRQUFRLElBQVIsQ0FBYSxJQUFiLENBQWIsRUFBakIsRUFBb0QsVUFBVSxPQUFWLEVBQW1CLE1BQW5CLEVBQTJCO0FBQzdFLGNBQUksVUFBVSxPQUFPLElBQVAsQ0FBWSxjQUFaLENBQTJCLEVBQXpDLEVBQTZDO0FBQzNDLGdCQUFJLFdBQVcsUUFBUSxDQUFSLEVBQVcsUUFBWCxDQUFvQixRQUFuQztBQUNBLDZCQUFpQixFQUFFLEtBQUssU0FBUyxHQUFULEVBQVAsRUFBdUIsS0FBSyxTQUFTLEdBQVQsRUFBNUIsRUFBakI7QUFDRDtBQUNGLFNBTEQ7QUFNRCxPQWREO0FBZUQ7O0FBRUQsUUFBSSxpQkFBSixHQUF3QixPQUF4Qjs7QUFFQTtBQUNELEdBeFhELEVBd1hHLE1BeFhILEVBd1hXLFFBeFhYIiwiZmlsZSI6ImFwcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKHdpbiwgZG9jKSB7XHJcbiAgXCJ1c2Ugc3RyaWN0XCJcclxuXHJcbiAgdmFyICRmb3JtID0gZG9jLmdldEVsZW1lbnRCeUlkKCdtYXBzRm9ybScpO1xyXG4gIHZhciAkbW9kYWwgPSAkKCcjbWFwc01vZGFsJyk7XHJcbiAgdmFyIG1hcCwgbWFya2VyLCBhdXRvY29tcGxldGUsIGdlb2NvZGVyO1xyXG4gIHZhciBpbml0aWFsRGF0YSA9IHtcclxuICAgIC8vIHN0cmVldDogJ03DoXJpbyBDYXJuaWNlbGknLFxyXG4gICAgLy8gY291bnRyeTogJ0JSJyxcclxuICAgIC8vIHN0YXRlOiAnU1AnLFxyXG4gICAgLy8gY2l0eTogJ0NhbXBpbmFzJ1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gRmllbGQgKHByb3BzKSB7XHJcbiAgICB2YXIgZGVmYXVsdHMgPSB7XHJcbiAgICAgIHZhbHVlOiAnJyxcclxuICAgICAgcmVxdWlyZWQ6IHRydWVcclxuICAgIH1cclxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0cywgcHJvcHMpO1xyXG4gIH1cclxuXHJcbiAgdmFyIEZPUk1fRklFTERTX1NDSEVNQSA9IHtcclxuICAgIHN0cmVldDogbmV3IEZpZWxkKCksXHJcbiAgICBjb3VudHJ5OiBuZXcgRmllbGQoKSxcclxuICAgIHN0YXRlOiBuZXcgRmllbGQoKSxcclxuICAgIGNpdHk6IG5ldyBGaWVsZCgpLFxyXG4gICAgbmVpZ2hib3Job29kOiBuZXcgRmllbGQoeyByZXF1aXJlZDogZmFsc2UgfSksXHJcbiAgICBjZXA6IG5ldyBGaWVsZCgpLFxyXG4gICAgbGF0OiBuZXcgRmllbGQoKSxcclxuICAgIGxuZzogbmV3IEZpZWxkKClcclxuICB9XHJcblxyXG4gIHZhciBGT1JNX0ZJRUxEU19NQVAgPSB7XHJcbiAgICByb3V0ZTogWydsb25nX25hbWUnLCAnc3RyZWV0J10sXHJcbiAgICBjb3VudHJ5OiBbJ3Nob3J0X25hbWUnLCAnY291bnRyeSddLFxyXG4gICAgYWRtaW5pc3RyYXRpdmVfYXJlYV9sZXZlbF8yOiBbJ2xvbmdfbmFtZScsICdjaXR5J10sXHJcbiAgICBhZG1pbmlzdHJhdGl2ZV9hcmVhX2xldmVsXzE6IFsnc2hvcnRfbmFtZScsICdzdGF0ZSddLFxyXG4gICAgc3VibG9jYWxpdHlfbGV2ZWxfMTogWydsb25nX25hbWUnLCAnbmVpZ2hib3Job29kJ10sXHJcbiAgICBwb3N0YWxfY29kZTogWydsb25nX25hbWUnLCAnY2VwJ11cclxuICB9O1xyXG4gIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xyXG5cclxuICBmdW5jdGlvbiBmZXRjaEJhc2ljRmllbGRzICgpIHtcclxuICAgICQud2hlbihnZXRDb3VudHJpZXMoKSwgZ2V0U3RhdGVzKCksIGdldENpdGllcygpKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdXBkYXRlRm9ybShpbml0aWFsRGF0YSk7XHJcbiAgICAgIH0sIDEwMDApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBnZXRDb3VudHJpZXMgKCkge1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgbWV0aG9kOiAnR0VUJyxcclxuICAgICAgdXJsOiAnc3JjL2pzb24vY291bnRyaWVzLmpzb24nXHJcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICB2YXIgJGNvdW50cmllc1NlbGVjdCA9ICRmb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPVwiY291bnRyeVwiXScpXHJcbiAgICAgIHZhciAkY291bnRyeUxpc3QgPSAnPG9wdGlvbiB2YWx1ZT1cIlwiPlNlbGVjaW9uZTwvb3B0aW9uPic7XHJcbiAgICAgIHJlc3BvbnNlLmZvckVhY2goZnVuY3Rpb24gKGNvdW50cnkpIHtcclxuICAgICAgICByZXR1cm4gJGNvdW50cnlMaXN0ICs9ICc8b3B0aW9uIHZhbHVlPVwiJyArIGNvdW50cnkuaXNvICsgJ1wiPicgKyBjb3VudHJ5Lm5hbWUgKyAnPC9vcHRpb24+JztcclxuICAgICAgfSlcclxuXHJcbiAgICAgICRjb3VudHJpZXNTZWxlY3QuaW5uZXJIVE1MID0gJGNvdW50cnlMaXN0O1xyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGdldFN0YXRlcyAoKSB7XHJcbiAgICAkLmFqYXgoe1xyXG4gICAgICBtZXRob2Q6ICdHRVQnLFxyXG4gICAgICB1cmw6ICdzcmMvanNvbi9zdGF0ZXMuanNvbidcclxuICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcbiAgICAgIHZhciAkc3RhdGVzU2VsZWN0ID0gJGZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCJzdGF0ZVwiXScpXHJcbiAgICAgIHZhciAkc3RhdGVMaXN0ID0gJzxvcHRpb24gdmFsdWU9XCJcIj5TZWxlY2lvbmU8L29wdGlvbj4nO1xyXG4gICAgICByZXNwb25zZS5mb3JFYWNoKGZ1bmN0aW9uIChzdGF0ZSkge1xyXG4gICAgICAgIHJldHVybiAkc3RhdGVMaXN0ICs9ICc8b3B0aW9uIHZhbHVlPVwiJyArIHN0YXRlLmNvZGUgKyAnXCI+JyArIHN0YXRlLm5hbWUgKyAnPC9vcHRpb24+JztcclxuICAgICAgfSlcclxuXHJcbiAgICAgICRzdGF0ZXNTZWxlY3QuaW5uZXJIVE1MID0gJHN0YXRlTGlzdDtcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBnZXRDaXRpZXMgKCkge1xyXG4gICAgJC5hamF4KHtcclxuICAgICAgbWV0aG9kOiAnR0VUJyxcclxuICAgICAgdXJsOiAnc3JjL2pzb24vY2l0aWVzLmpzb24nXHJcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICB2YXIgJGNpdGllc1NlbGVjdCA9ICRmb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPVwiY2l0eVwiXScpXHJcbiAgICAgIHZhciAkY2l0eUxpc3QgPSAnPG9wdGlvbiB2YWx1ZT1cIlwiPlNlbGVjaW9uZTwvb3B0aW9uPic7XHJcbiAgICAgIHJlc3BvbnNlLmZvckVhY2goZnVuY3Rpb24gKGNpdHkpIHtcclxuICAgICAgICByZXR1cm4gJGNpdHlMaXN0ICs9ICc8b3B0aW9uIHZhbHVlPVwiJyArIGNpdHkubmFtZSArICdcIj4nICsgY2l0eS5uYW1lICsgJzwvb3B0aW9uPic7XHJcbiAgICAgIH0pXHJcblxyXG4gICAgICAkY2l0aWVzU2VsZWN0LmlubmVySFRNTCA9ICRjaXR5TGlzdDtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cclxuXHJcbiAgZnVuY3Rpb24gdXBkYXRlRm9ybSAoZmllbGRzKSB7XHJcbiAgICBpZiAoZmllbGRzKSB7XHJcbiAgICAgIHZhciBhZGRyZXNzID0gT2JqZWN0LmFzc2lnbih7fSwgRk9STV9GSUVMRFNfU0NIRU1BLCBmaWVsZHMpO1xyXG5cclxuICAgICAgT2JqZWN0LmtleXMoYWRkcmVzcykuZm9yRWFjaChmdW5jdGlvbiAoZmllbGQpIHtcclxuICAgICAgICB2YXIgZWxlbWVudCA9ICRmb3JtLmVsZW1lbnRzW2ZpZWxkXTtcclxuICAgICAgICBpZiAoZWxlbWVudCkge1xyXG4gICAgICAgICAgJGZvcm0uZWxlbWVudHNbZmllbGRdLnZhbHVlID0gKGZpZWxkc1tmaWVsZF0gJiYgZmllbGRzW2ZpZWxkXSAhPSAnVW5uYW1lZCBSb2FkJykgPyBmaWVsZHNbZmllbGRdIDogJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGdlb2NvZGVQb3NpdGlvbiAocG9zKSB7XHJcbiAgICBnZW9jb2Rlci5nZW9jb2RlKHtcclxuICAgICAgbGF0TG5nOiBwb3NcclxuICAgIH0sIGZ1bmN0aW9uIChyZXNwb25zZXMpIHtcclxuICAgICAgaWYgKHJlc3BvbnNlcyAmJiByZXNwb25zZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHZhciBhZGRyZXNzID0gbWFwQXBpVG9Gb3JtRmllbGRzKHJlc3BvbnNlc1swXSk7XHJcbiAgICAgICAgYWRkcmVzcy5sYXQgPSBwb3MubGF0O1xyXG4gICAgICAgIGFkZHJlc3MubG5nID0gcG9zLmxuZztcclxuICAgICAgICB1cGRhdGVGb3JtKGFkZHJlc3MpO1xyXG4gICAgICAgIHJlc2V0TWFwUG9zaXRpb24ocG9zLCB0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBoYW5kbGVNYXJrZXJEcmFnIChlKSB7XHJcbiAgICB2YXIgbGF0TG5nID0ge1xyXG4gICAgICBsYXQ6IGUubGF0TG5nLmxhdCgpLFxyXG4gICAgICBsbmc6IGUubGF0TG5nLmxuZygpXHJcbiAgICB9XHJcbiAgICBnZW9jb2RlUG9zaXRpb24obGF0TG5nKTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGNsZWFuRm9ybUVycm9ycyAoKSB7XHJcbiAgICB2YXIgJGVycm9yc1RleHQgPSAkZm9ybS5xdWVyeVNlbGVjdG9yQWxsKCcudGV4dC1kYW5nZXInKTtcclxuICAgIHZhciAkZXJyb3JzQ2xhc3MgPSAkZm9ybS5xdWVyeVNlbGVjdG9yQWxsKCcuaXMtaW52YWxpZCcpO1xyXG5cclxuICAgICRlcnJvcnNUZXh0LmZvckVhY2goKGVycm9yKSA9PiB7XHJcbiAgICAgIGVycm9yLnJlbW92ZSgpO1xyXG4gICAgfSlcclxuXHJcbiAgICAkZXJyb3JzQ2xhc3MuZm9yRWFjaCgoZXJyb3IpID0+IHtcclxuICAgICAgZXJyb3IuY2xhc3NMaXN0LnJlbW92ZSgnaXMtaW52YWxpZCcpO1xyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHJlc2V0TWFwUG9zaXRpb24gKHBvcywgem9vbSkge1xyXG4gICAgaWYgKHBvcy5sYXQgJiYgcG9zLmxuZykge1xyXG4gICAgICBtYXAuc2V0Q2VudGVyKHBvcyk7XHJcbiAgICAgIG1hcmtlci5zZXRQb3NpdGlvbihwb3MpO1xyXG4gICAgICBpZiAoem9vbSkge1xyXG4gICAgICAgIG1hcC5zZXRab29tKDE5KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZ2V0Rm9ybVZhbHVlcyAoKSB7XHJcbiAgICB2YXIgdmFsdWVzID0ge307XHJcbiAgICBPYmplY3Qua2V5cyhGT1JNX0ZJRUxEU19TQ0hFTUEpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xyXG4gICAgICB2YXIgZmllbGQgPSAkZm9ybS5lbGVtZW50c1trZXldO1xyXG4gICAgICBpZiAoZmllbGQpIHtcclxuICAgICAgICB2YWx1ZXNba2V5XSA9ICRmb3JtLmVsZW1lbnRzW2tleV0udmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB2YWx1ZXM7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiB2YWxpZGF0ZUZvcm0gKCkge1xyXG4gICAgY2xlYW5Gb3JtRXJyb3JzKCk7XHJcblxyXG4gICAgdmFyIGZvcm1WYWx1ZXMgPSBnZXRGb3JtVmFsdWVzKCk7XHJcbiAgICB2YXIgaXNWYWxpZCA9IE9iamVjdC5rZXlzKGZvcm1WYWx1ZXMpLmV2ZXJ5KGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgcmV0dXJuICEhZm9ybVZhbHVlc1trZXldIHx8ICFGT1JNX0ZJRUxEU19TQ0hFTUFba2V5XS5yZXF1aXJlZDtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiAkLkRlZmVycmVkKGZ1bmN0aW9uICgpIHtcclxuICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgICAgaWYgKCFpc1ZhbGlkKSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMoZm9ybVZhbHVlcykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgICB2YXIgJGZpZWxkID0gJGZvcm0uZWxlbWVudHNba2V5XTtcclxuXHJcbiAgICAgICAgICBpZiAoISRmaWVsZC52YWx1ZSAmJiAkZmllbGQudHlwZSAhPSAnaGlkZGVuJyAmJiBGT1JNX0ZJRUxEU19TQ0hFTUFba2V5XS5yZXF1aXJlZCkge1xyXG4gICAgICAgICAgICAkZmllbGQuY2xhc3NMaXN0LmFkZCgnaXMtaW52YWxpZCcpO1xyXG4gICAgICAgICAgICAkZmllbGQucGFyZW50Tm9kZS5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyZW5kJywgJzxzbWFsbCBjbGFzcz1cInRleHQtZGFuZ2VyIG10LTJcIj5PYnJpZ2F0w7NyaW88L3NtYWxsPicpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHJldHVybiAhIWZvcm1WYWx1ZXNba2V5XTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHNlbGYucmVzb2x2ZShmYWxzZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB2YWxpZGF0ZUFkZHJlc3NBc3luYyhmb3JtVmFsdWVzKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gc2VsZi5yZXNvbHZlKGlzVmFsaWQpO1xyXG4gICAgICB9KS5mYWlsKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gc2VsZi5yZWplY3QoZmFsc2UpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHZhbGlkYXRlQWRkcmVzc0FzeW5jIChhZGRyZXNzKSB7XHJcbiAgICByZXR1cm4gJC5EZWZlcnJlZChmdW5jdGlvbiAoKSB7XHJcbiAgICAgIHZhciBzZWxmID0gdGhpcztcclxuICAgICAgdmFyIGxhdExuZyA9IHtcclxuICAgICAgICBsYXQ6IHBhcnNlRmxvYXQoYWRkcmVzcy5sYXQpLFxyXG4gICAgICAgIGxuZzogcGFyc2VGbG9hdChhZGRyZXNzLmxuZylcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGdlb2NvZGVyLmdlb2NvZGUoeyAnbG9jYXRpb24nOiBsYXRMbmcgfSwgZnVuY3Rpb24gKHJlc3VsdHMsIHN0YXR1cykge1xyXG4gICAgICAgIGlmIChzdGF0dXMgPT0gZ29vZ2xlLm1hcHMuR2VvY29kZXJTdGF0dXMuT0spIHtcclxuICAgICAgICAgIHZhciBtYXBzQWRkcmVzcyA9IG1hcEFwaVRvRm9ybUZpZWxkcyhyZXN1bHRzWzBdKTtcclxuXHJcbiAgICAgICAgICBpZiAobWFwc0FkZHJlc3Muc3RyZWV0ICYmIG1hcHNBZGRyZXNzLnN0cmVldCAhPSBhZGRyZXNzLnN0cmVldCkge1xyXG4gICAgICAgICAgICAkZm9ybS5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyZW5kJywgJzxzbWFsbCBjbGFzcz1cInRleHQtZGFuZ2VyIG10LTJcIj5Mb2dyYWRvdXJvIGluY29ycmV0bzwvc21hbGw+JylcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBpZiAobWFwc0FkZHJlc3MubmVpZ2hib3Job29kICYmIG1hcHNBZGRyZXNzLm5laWdoYm9yaG9vZCAhPSBhZGRyZXNzLm5laWdoYm9yaG9vZCkge1xyXG4gICAgICAgICAgICAkZm9ybS5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyZW5kJywgJzxkaXYgY2xhc3M9XCJpcy1pbnZhbGlkXCI+PHNtYWxsIGNsYXNzPVwidGV4dC1kYW5nZXIgbXQtMlwiPkJhaXJybyBpbmNvcnJldG88L3NtYWxsPjwvZGl2PicpXHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKG1hcHNBZGRyZXNzLmNlcCAmJiBtYXBzQWRkcmVzcy5jZXAgIT0gYWRkcmVzcy5jZXApIHtcclxuICAgICAgICAgICAgJGZvcm0uaW5zZXJ0QWRqYWNlbnRIVE1MKCdhZnRlcmVuZCcsICc8ZGl2IGNsYXNzPVwiaXMtaW52YWxpZFwiPjxzbWFsbCBjbGFzcz1cInRleHQtZGFuZ2VyIG10LTJcIj5CYWlycm8gaW5jb3JyZXRvPC9zbWFsbD48L2Rpdj4nKVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHNlbGYucmVzb2x2ZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBzZWxmLnJlamVjdCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gaGFuZGxlU3VibWl0IChlLCBjYWxsYmFjaykge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFsaWRhdGVGb3JtKCkudGhlbihmdW5jdGlvbiAodmFsaWQpIHtcclxuICAgICAgaWYgKHZhbGlkKSB7XHJcbiAgICAgICAgdmFyIHZhbHVlcyA9IGdldEZvcm1WYWx1ZXMoKTtcclxuICAgICAgICBjb25zb2xlLmxvZygnZm9ybUZpZWxkcycsIHZhbHVlcyk7XHJcblxyXG4gICAgICAgIGlmIChjYWxsYmFjaykge1xyXG4gICAgICAgICAgY2FsbGJhY2sodmFsdWVzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgICRtb2RhbC5tb2RhbCgnaGlkZScpO1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGhhbmRsZUF1dG9jb21wbGV0ZSAoKSB7XHJcbiAgICBjbGVhbkZvcm1FcnJvcnMoKTtcclxuICAgIHZhciBwbGFjZSA9IGF1dG9jb21wbGV0ZS5nZXRQbGFjZSgpO1xyXG4gICAgaWYgKE9iamVjdC5rZXlzKHBsYWNlKS5sZW5ndGggPiAxKSB7XHJcbiAgICAgIHZhciBhZGRyZXNzID0gbWFwQXBpVG9Gb3JtRmllbGRzKHBsYWNlKTtcclxuICAgICAgdXBkYXRlRm9ybShhZGRyZXNzKTtcclxuICAgICAgcmVzZXRNYXBQb3NpdGlvbih7IGxhdDogYWRkcmVzcy5sYXQsIGxuZzogYWRkcmVzcy5sbmcgfSwgdHJ1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBmaW5kTG9jYXRpb24gKHZhbHVlKSB7XHJcbiAgICBjbGVhbkZvcm1FcnJvcnMoKTtcclxuICAgIGdlb2NvZGVyLmdlb2NvZGUoeyAnYWRkcmVzcyc6IHZhbHVlIH0sIGZ1bmN0aW9uIChyZXN1bHRzLCBzdGF0dXMpIHtcclxuICAgICAgaWYgKHN0YXR1cyA9PSBnb29nbGUubWFwcy5HZW9jb2RlclN0YXR1cy5PSykge1xyXG4gICAgICAgIHZhciBhZGRyZXNzID0gbWFwQXBpVG9Gb3JtRmllbGRzKHJlc3VsdHNbMF0pO1xyXG4gICAgICAgIHZhciBsb2NhdGlvbiA9IHJlc3VsdHNbMF0uZ2VvbWV0cnkubG9jYXRpb247XHJcbiAgICAgICAgcmVzZXRNYXBQb3NpdGlvbih7IGxhdDogbG9jYXRpb24ubGF0KCksIGxuZzogbG9jYXRpb24ubG5nKCkgfSlcclxuICAgICAgICB1cGRhdGVGb3JtKGFkZHJlc3MpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ05lbmh1bSByZXN1bHRhZG8gZW5jb250cmFkbycpO1xyXG4gICAgICAgICRmb3JtLmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywgJzxkaXYgY2xhc3M9XCJpcy1pbnZhbGlkXCI+PHNtYWxsIGNsYXNzPVwidGV4dC1kYW5nZXIgbXQtMlwiPkVuZGVyZcOnbyBuw6NvIGVuY29udHJhZG88L3NtYWxsPjwvZGl2PicpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIG1hcEFwaVRvRm9ybUZpZWxkcyAocGxhY2UpIHtcclxuICAgIHZhciBhZGRyZXNzID0ge307XHJcbiAgICBhZGRyZXNzLmxhdCA9IHBsYWNlLmdlb21ldHJ5LmxvY2F0aW9uLmxhdCgpO1xyXG4gICAgYWRkcmVzcy5sbmcgPSBwbGFjZS5nZW9tZXRyeS5sb2NhdGlvbi5sbmcoKTtcclxuXHJcbiAgICBwbGFjZS5hZGRyZXNzX2NvbXBvbmVudHMuZm9yRWFjaChmdW5jdGlvbiAoY29tcG9uZW50KSB7XHJcbiAgICAgIHZhciBmb3JtRmllbGQ7XHJcblxyXG4gICAgICBjb21wb25lbnQudHlwZXMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkge1xyXG4gICAgICAgIGlmIChGT1JNX0ZJRUxEU19NQVBbdHlwZV0pIHtcclxuICAgICAgICAgIGZvcm1GaWVsZCA9IEZPUk1fRklFTERTX01BUFt0eXBlXTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKGZvcm1GaWVsZCkge1xyXG4gICAgICAgIHZhciB2YWx1ZSA9IGNvbXBvbmVudFtmb3JtRmllbGRbMF1dO1xyXG4gICAgICAgIGFkZHJlc3NbZm9ybUZpZWxkWzFdXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gYWRkcmVzcztcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHNldExvYWRpbmcgKHNob3cpIHtcclxuICAgIHZhciAkbG9hZGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXBzTG9hZGluZycpO1xyXG4gICAgaWYgKCRsb2FkaW5nKSB7XHJcbiAgICAgIGlmICghc2hvdykge1xyXG4gICAgICAgICRsb2FkaW5nLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgJGxvYWRpbmcuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGluaXRNYXAgKGZvcm1EYXRhLCBjYWxsYmFjaykge1xyXG4gICAgaWYgKGZvcm1EYXRhKSB7XHJcbiAgICAgIGluaXRpYWxEYXRhID0gZm9ybURhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgZmV0Y2hCYXNpY0ZpZWxkcygpXHJcbiAgICAvLyB2YXIgbGF0TG5nID0ge1xyXG4gICAgLy8gICBsYXQ6IGluaXRpYWxEYXRhLmxhdCxcclxuICAgIC8vICAgbG5nOiBpbml0aWFsRGF0YS5sbmdcclxuICAgIC8vIH07XHJcblxyXG4gICAgZ2VvY29kZXIgPSBuZXcgZ29vZ2xlLm1hcHMuR2VvY29kZXIoKTtcclxuICAgIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jLmdldEVsZW1lbnRCeUlkKCdtYXAnKSwge1xyXG4gICAgICAvLyBjZW50ZXI6IGxhdExuZyxcclxuICAgICAgem9vbTogMTIsXHJcbiAgICAgIG1hcFR5cGVDb250cm9sOiB0cnVlLFxyXG4gICAgICBtYXBUeXBlQ29udHJvbE9wdGlvbnM6IHtcclxuICAgICAgICBwb3NpdGlvbjogZ29vZ2xlLm1hcHMuQ29udHJvbFBvc2l0aW9uLlRPUF9DRU5URVJcclxuICAgICAgfSxcclxuICAgICAgZnVsbHNjcmVlbkNvbnRyb2w6IGZhbHNlXHJcbiAgICB9KTtcclxuXHJcbiAgICBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgLy8gcG9zaXRpb246IGxhdExuZyxcclxuICAgICAgbWFwOiBtYXAsXHJcbiAgICAgIGRyYWdnYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcblxyXG4gICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnZHJhZ2VuZCcsIGhhbmRsZU1hcmtlckRyYWcpO1xyXG4gICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFwLCAndGlsZXNsb2FkZWQnLCBzZXRMb2FkaW5nKTtcclxuXHJcbiAgICBhdXRvY29tcGxldGUgPSBuZXcgZ29vZ2xlLm1hcHMucGxhY2VzLkF1dG9jb21wbGV0ZSgoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2F1dG9jb21wbGV0ZScpKSwgeyB0eXBlczogWydnZW9jb2RlJ10gfSk7XHJcbiAgICBhdXRvY29tcGxldGUuYWRkTGlzdGVuZXIoJ3BsYWNlX2NoYW5nZWQnLCBoYW5kbGVBdXRvY29tcGxldGUpO1xyXG5cclxuICAgICRmb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgIGhhbmRsZVN1Ym1pdChlLCBjYWxsYmFjayk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAkZm9ybS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICBzd2l0Y2ggKGUudGFyZ2V0Lm5hbWUpIHtcclxuICAgICAgICBjYXNlICdjZXAnOlxyXG4gICAgICAgICAgZmluZExvY2F0aW9uKGUudGFyZ2V0LnZhbHVlKTtcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICAkbW9kYWwub24oXCJzaG93bi5icy5tb2RhbFwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LnRyaWdnZXIobWFwLCBcInJlc2l6ZVwiKTtcclxuICAgICAgdmFyIGFkZHJlc3MgPSBbXTtcclxuXHJcbiAgICAgIE9iamVjdC5rZXlzKGluaXRpYWxEYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgICBhZGRyZXNzLnB1c2goaW5pdGlhbERhdGFba2V5XSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZ2VvY29kZXIuZ2VvY29kZSh7ICdhZGRyZXNzJzogYWRkcmVzcy5qb2luKCcsICcpIH0sIGZ1bmN0aW9uIChyZXN1bHRzLCBzdGF0dXMpIHtcclxuICAgICAgICBpZiAoc3RhdHVzID09IGdvb2dsZS5tYXBzLkdlb2NvZGVyU3RhdHVzLk9LKSB7XHJcbiAgICAgICAgICB2YXIgbG9jYXRpb24gPSByZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uO1xyXG4gICAgICAgICAgcmVzZXRNYXBQb3NpdGlvbih7IGxhdDogbG9jYXRpb24ubGF0KCksIGxuZzogbG9jYXRpb24ubG5nKCkgfSlcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICB3aW4ubWFwc0FkZHJlc3NGaW5kZXIgPSBpbml0TWFwO1xyXG5cclxuICAvLyBkb2MuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGluaXRNYXApXHJcbn0pKHdpbmRvdywgZG9jdW1lbnQpIl19